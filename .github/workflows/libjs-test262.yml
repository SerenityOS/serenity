name: Run test262 with LibJS and push results to the website repo

on: [push]

env:
  SERENITY_SOURCE_DIR: ${{ github.workspace }}

jobs:
  run_and_update_results:
    runs-on: self-hosted
    if: always() && github.repository == 'SerenityOS/serenity'

    concurrency: libjs-test262

    steps:
      - name: Cleanup
        run: |
          echo "Cleaning up previous run"
          rm -rf "${{ github.workspace }}/*"

      - name: Checkout SerenityOS/serenity
        uses: actions/checkout@v3

      - name: Checkout SerenityOS/libjs-test262
        uses: actions/checkout@v3
        with:
          repository: SerenityOS/libjs-test262
          path: libjs-test262

      - name: Checkout tc39/test262
        uses: actions/checkout@v3
        with:
          repository: tc39/test262
          path: test262

      - name: Checkout tc39/test262-parser-tests
        uses: actions/checkout@v3
        with:
          repository: tc39/test262-parser-tests
          path: test262-parser-tests

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build unzip gcc-12 g++-12 jq wget
          test -e /opt/wabt-1.0.27 || (
            cd /tmp
            wget https://github.com/WebAssembly/wabt/releases/download/1.0.27/wabt-1.0.27-ubuntu.tar.gz
            sudo tar xf wabt-1.0.27-ubuntu.tar.gz -C /opt
            rm wabt-1.0.27-ubuntu.tar.gz
          )

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        # The setup-python action set default python to python3.x. Note that we are not using system python here.
        run: |
          python -m pip install --upgrade pip
          pip install -r libjs-test262/requirements.txt

      - name: Check versions
        run: set +e; g++ --version; g++-12 --version; python --version; python3 --version; ninja --version

      - name: TimeZoneData cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/libjs-test262/Build/TZDB
          key: TimeZoneData-${{ hashFiles('Meta/CMake/time_zone_data.cmake') }}

      - name: UnicodeData cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/libjs-test262/Build/UCD
          key: UnicodeData-${{ hashFiles('Meta/CMake/unicode_data.cmake') }}

      - name: UnicodeLocale cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/libjs-test262/Build/CLDR
          key: UnicodeLocale-${{ hashFiles('Meta/CMake/locale_data.cmake') }}

      - name: Build test262-runner, test-js and test-wasm
        working-directory: libjs-test262
        run: |
          cd Build
          env PATH="/opt/wabt-1.0.27/bin:$PATH" \
              cmake -GNinja -DCMAKE_C_COMPILER=gcc-12 -DCMAKE_CXX_COMPILER=g++-12 -DWASM_SPEC_TEST_SKIP_FORMATTING=ON -DINCLUDE_WASM_SPEC_TESTS=ON -DSERENITY_SOURCE_DIR=${{ env.SERENITY_SOURCE_DIR }} ..
          ninja test262-runner test-js test-wasm

      - name: Download LibJS results
        continue-on-error: true
        uses: actions/download-artifact@v3
        with:
          name: libjs-results
          path: old-libjs-results

      - name: Download Wasm results
        continue-on-error: true
        uses: actions/download-artifact@v3
        with:
          name: libwasm-results
          path: old-libwasm-results

      - name: Create results directories
        # If the previous results don't exist yet, create empty files so the steps below can assume they exist.
        run: |
          mkdir -p new-libjs-results
          mkdir -p new-libwasm-results

          if [ ! -d old-libjs-results ]
          then
            mkdir -p old-libjs-results
            touch old-libjs-results/results.json
            touch old-libjs-results/per-file-ast.json
            touch old-libjs-results/per-file-bytecode.json
          fi

          if [ ! -d old-libwasm-results ]
          then
            mkdir -p old-libwasm-results
            touch old-libwasm-results/results.json
            touch old-libwasm-results/per-file-wasm.json
          fi

      - name: Run test262 and test262-parser-tests
        working-directory: libjs-test262
        run: |
          python3 run_all_and_update_results.py \
            --serenity .. \
            --test262 ../test262 \
            --test262-parser-tests ../test262-parser-tests \
            --results-json ../new-libjs-results/results.json \
            --per-file-output ../new-libjs-results/per-file-ast.json \
            --per-file-bytecode-output ../new-libjs-results/per-file-bytecode.json

      - name: Run test-wasm
        working-directory: libjs-test262/Build
        run: |
          _deps/lagom-build/bin/test-wasm --per-file _deps/lagom-build/Userland/Libraries/LibWasm/Tests > ../../new-libwasm-results/per-file-wasm.json || true
          jq -nc -f /dev/stdin <<-EOF --slurpfile previous ../../old-libwasm-results/per-file-wasm.json --slurpfile details ../../new-libwasm-results/per-file-wasm.json > wasm-new-results.json
            \$details[0] as \$details | \$previous[0] + [{
              "commit_timestamp": $(git -C ../.. log -1 --format=%ct),
              "run_timestamp": $(date +%s),
              "versions": {
                "serenity": "$(git -C ../.. rev-parse HEAD)"
              },
              "tests": {
                "spectest": {
                  "duration": (\$details.duration),
                  "results": {
                    "total": (\$details.results | keys | length),
                    "passed": ([\$details.results | values[] | select(. == "PASSED")] | length),
                    "failed": ([\$details.results | values[] | select(. == "FAILED")] | length),
                    "skipped": ([\$details.results | values[] | select(. == "SKIPPED")] | length),
                    "process_error": ([\$details.results | values[] | select(. == "PROCESS_ERROR")] | length)
                  }
                }
              }
            }]
          EOF
          mv wasm-new-results.json ../../new-libwasm-results/results.json

      - name: Compare AST
        continue-on-error: true
        run: ./per_file_result_diff.py -o old-libjs-results/per-file-ast.json -n new-libjs-results/per-file-ast.json

      - name: Compare bytecode
        continue-on-error: true
        run: ./per_file_result_diff.py -o old-libjs-results/per-file-bytecode.json -n new-libjs-results/per-file-bytecode.json

      - name: Compare AST to bytecode
        continue-on-error: true
        run: ./per_file_result_diff.py -o new-libjs-results/per-file-ast.json -n new-libjs-results/per-file-bytecode.json

      - name: Compare Wasm
        continue-on-error: true
        run: ./per_file_result_diff.py -o old-libwasm-results/per-file-wasm.json -n new-libwasm-results/per-file-wasm.json

      - name: Upload LibJS results
        uses: actions/upload-artifact@v3
        with:
          name: libjs-results
          path: new-libjs-results

      - name: Upload Wasm results
        uses: actions/upload-artifact@v3
        with:
          name: wasm-results
          path: new-wasm-results
