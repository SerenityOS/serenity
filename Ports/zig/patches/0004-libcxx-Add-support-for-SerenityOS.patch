From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: sin-ack <sin-ack@protonmail.com>
Date: Tue, 27 Sep 2022 00:08:46 +0000
Subject: [PATCH] [libcxx] Add support for SerenityOS

This commit teaches libc++ about what features are available in our
LibC, namely:
* We do not have locale support, so no-op shims should be used in place
  of the C locale API.
* The number of errno constants defined by us is given by the value of
  the `ELAST` macro.
* Multithreading is implemented though the pthread library.
* Use libc++'s builtin character type table instead of the one provided
  by LibC as there's a lot of extra porting work to convince the rest of
  locale.cpp to use our character type table properly.

This commit is an adaptation of the LLVM patch by Daniel Bertalan to fit
the layout of the zig-bootstrap project.

Co-Authored-By: Daniel Bertalan <dani@danielbertalan.dev>
Co-Authored-By: Linus Groh <mail@linusgroh.de>
---
 zig/lib/libcxx/include/__config               |  5 +++--
 .../include/__locale_dir/locale_base_api.h    |  2 ++
 .../__locale_dir/locale_base_api/serenity.h   | 22 +++++++++++++++++++
 zig/lib/libcxx/include/locale                 |  2 +-
 zig/lib/libcxx/src/include/config_elast.h     |  2 ++
 5 files changed, 30 insertions(+), 3 deletions(-)
 create mode 100644 zig/lib/libcxx/include/__locale_dir/locale_base_api/serenity.h

diff --git a/zig/lib/libcxx/include/__config b/zig/lib/libcxx/include/__config
index 8165dbc5490711e36f88110fc2231f110590251d..b5d78ee2c7a7234ca09b73a4c98c9c56ca5e5a2e 100644
--- a/zig/lib/libcxx/include/__config
+++ b/zig/lib/libcxx/include/__config
@@ -817,7 +817,8 @@ typedef __char32_t char32_t;
         defined(__APPLE__) ||                                                                                          \
         defined(__MVS__) ||                                                                                            \
         defined(_AIX) ||                                                                                               \
-        defined(__EMSCRIPTEN__)
+        defined(__EMSCRIPTEN__) ||                                                                                     \
+        defined(__serenity__)
 // clang-format on
 #      define _LIBCPP_HAS_THREAD_API_PTHREAD
 #    elif defined(__Fuchsia__)
@@ -890,7 +891,7 @@ typedef __char32_t char32_t;
 #  endif
 
 #  if defined(__BIONIC__) || defined(__NuttX__) || defined(__Fuchsia__) || defined(__wasi__) ||                        \
-      defined(_LIBCPP_HAS_MUSL_LIBC) || defined(__OpenBSD__)
+      defined(_LIBCPP_HAS_MUSL_LIBC) || defined(__OpenBSD__) || defined(__serenity__)
 #    define _LIBCPP_PROVIDES_DEFAULT_RUNE_TABLE
 #  endif
 
diff --git a/zig/lib/libcxx/include/__locale_dir/locale_base_api.h b/zig/lib/libcxx/include/__locale_dir/locale_base_api.h
index 8c000c558c52793f5f334d11898da8e7e8486388..bb5745019fc5dabec88115fe9ef3b424574dd31a 100644
--- a/zig/lib/libcxx/include/__locale_dir/locale_base_api.h
+++ b/zig/lib/libcxx/include/__locale_dir/locale_base_api.h
@@ -25,6 +25,8 @@
 #  include <__locale_dir/locale_base_api/fuchsia.h>
 #elif defined(__wasi__) || defined(_LIBCPP_HAS_MUSL_LIBC)
 #  include <__locale_dir/locale_base_api/musl.h>
+#elif defined(__serenity__)
+#  include <__locale_dir/locale_base_api/serenity.h>
 #elif defined(__APPLE__) || defined(__FreeBSD__)
 #  include <xlocale.h>
 #endif
diff --git a/zig/lib/libcxx/include/__locale_dir/locale_base_api/serenity.h b/zig/lib/libcxx/include/__locale_dir/locale_base_api/serenity.h
new file mode 100644
index 0000000000000000000000000000000000000000..4644fca4ae9595903933fe2c531b9e7298e19f60
--- /dev/null
+++ b/zig/lib/libcxx/include/__locale_dir/locale_base_api/serenity.h
@@ -0,0 +1,22 @@
+//===----------------------------------------------------------------------===//
+//
+// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
+// See https://llvm.org/LICENSE.txt for license information.
+// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
+//
+//===----------------------------------------------------------------------===//
+
+#ifndef _LIBCPP___LOCALE_LOCALE_BASE_API_SERENITY_H
+#define _LIBCPP___LOCALE_LOCALE_BASE_API_SERENITY_H
+
+#include <stddef.h>
+
+#include <__support/xlocale/__nop_locale_mgmt.h>
+#include <__support/xlocale/__posix_l_fallback.h>
+#include <__support/xlocale/__strtonum_fallback.h>
+#include <clocale>
+#include <cstdlib>
+#include <ctype.h>
+#include <cwctype>
+
+#endif // _LIBCPP___LOCALE_LOCALE_BASE_API_SERENITY_H
diff --git a/zig/lib/libcxx/include/locale b/zig/lib/libcxx/include/locale
index 573910a85bef540f48cf24f98a7a0226c1ae778e..ae19777a534614bfc862f871a40be70d4b15e670 100644
--- a/zig/lib/libcxx/include/locale
+++ b/zig/lib/libcxx/include/locale
@@ -220,7 +220,7 @@ template <class charT> class messages_byname;
 
 #  if defined(__unix__) || (defined(__APPLE__) && defined(__MACH__))
 // Most unix variants have catopen.  These are the specific ones that don't.
-#    if !defined(__BIONIC__) && !defined(_NEWLIB_VERSION) && !defined(__EMSCRIPTEN__)
+#    if !defined(__BIONIC__) && !defined(_NEWLIB_VERSION) && !defined(__EMSCRIPTEN__) && !defined(__serenity__)
 #      define _LIBCPP_HAS_CATOPEN 1
 #      include <nl_types.h>
 #    endif
diff --git a/zig/lib/libcxx/src/include/config_elast.h b/zig/lib/libcxx/src/include/config_elast.h
index 899e124ad261b23a95dc8cda9d0c550bfbf3078f..11d930bc8a3cee31b337d96c2a58f1bed2978062 100644
--- a/zig/lib/libcxx/src/include/config_elast.h
+++ b/zig/lib/libcxx/src/include/config_elast.h
@@ -35,6 +35,8 @@
 #  define _LIBCPP_ELAST 4095
 #elif defined(__APPLE__)
 // No _LIBCPP_ELAST needed on Apple
+#elif defined(__serenity__)
+// No _LIBCPP_ELAST needed on SerenityOS
 #elif defined(__MVS__)
 #  define _LIBCPP_ELAST 1160
 #elif defined(_LIBCPP_MSVCRT_LIKE)
