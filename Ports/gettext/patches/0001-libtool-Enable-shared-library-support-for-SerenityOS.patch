From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Tim Schumacher <timschumi@gmx.de>
Date: Tue, 1 Aug 2023 20:45:12 +0200
Subject: [PATCH] libtool: Enable shared library support for SerenityOS

For some odd reason, libtool handles the configuration for shared
libraries entirely statically and in its configure script. If no
shared library support is "present", building shared libraries is
disabled entirely.

Fix that by just adding the appropriate configuration options for
`serenity`. This allows us to finally create dynamic libraries
automatically using libtool, without having to manually link the
static library into a shared library.

This patch here is a bit more elaborate for other ports, as libintl's
configure includes the code for detecting dynamic linker characteristics
twice, and it also queries the C++ compiler for shared library support.

Co-Authored-By: Daniel Bertalan <dani@danielbertalan.dev>
---
 gettext-runtime/configure | 37 +++++++++++++++++++++++++++++++++++++
 1 file changed, 37 insertions(+)

diff --git a/gettext-runtime/configure b/gettext-runtime/configure
index 3fab6ea508ea48679dd2e8fc3a69624b11cd0822..9b376ddee209e2aed26a2a59bdf2d1e16e77c35a 100755
--- a/gettext-runtime/configure
+++ b/gettext-runtime/configure
@@ -12546,6 +12546,9 @@ tpf*)
 os2*)
   lt_cv_deplibs_check_method=pass_all
   ;;
+serenity*)
+  lt_cv_deplibs_check_method=pass_all
+  ;;
 esac
  ;;
 esac
@@ -16084,6 +16087,10 @@ lt_prog_compiler_static=
       lt_prog_compiler_static='-Bstatic'
       ;;
 
+    serenity*)
+      lt_prog_compiler_can_build_shared=yes
+      ;;
+
     *)
       lt_prog_compiler_can_build_shared=no
       ;;
@@ -17637,6 +17644,10 @@ printf '%s\n' "$lt_cv_irix_exported_symbol" >&6; }
       hardcode_shlibpath_var=no
       ;;
 
+    serenity*)
+      ld_shlibs=yes
+      ;;
+
     *)
       ld_shlibs=no
       ;;
@@ -18783,6 +18794,17 @@ uts4*)
   shlibpath_var=LD_LIBRARY_PATH
   ;;
 
+serenity*)
+  version_type=linux
+  need_lib_prefix=no
+  need_version=no
+  library_names_spec='${libname}${release}${shared_ext}${versuffix} ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
+  soname_spec='${libname}${release}${shared_ext}${major}'
+  shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
+  dynamic_linker='SerenityOS LibELF'
+  ;;
+
 emscripten*)
   version_type=none
   need_lib_prefix=no
@@ -21629,6 +21651,10 @@ fi
         ld_shlibs_CXX=no
         ;;
 
+      serenity*)
+        ld_shlibs_CXX=yes
+        ;;
+
       *)
         # FIXME: insert proper C++ library support
         ld_shlibs_CXX=no
@@ -23412,6 +23438,17 @@ uts4*)
   shlibpath_var=LD_LIBRARY_PATH
   ;;
 
+serenity*)
+  version_type=linux
+  need_lib_prefix=no
+  need_version=no
+  library_names_spec='${libname}${release}${shared_ext}${versuffix} ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
+  soname_spec='${libname}${release}${shared_ext}${major}'
+  shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
+  dynamic_linker='SerenityOS LibELF'
+  ;;
+
 emscripten*)
   version_type=none
   need_lib_prefix=no
