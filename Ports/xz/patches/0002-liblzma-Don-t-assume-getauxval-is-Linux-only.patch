From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?S=C3=B6nke=20Holz?= <soenke.holz@serenityos.org>
Date: Wed, 8 Jan 2025 21:10:05 +0100
Subject: [PATCH] liblzma: Don't assume getauxval is Linux-only

SerenityOS doesn't expose Linux-compatible hwcaps (like HWCAP_CRC32)
in the auxiliary vector.
---
 src/liblzma/check/crc32_arm64.h | 2 +-
 src/liblzma/check/crc_common.h  | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/liblzma/check/crc32_arm64.h b/src/liblzma/check/crc32_arm64.h
index fb0e8f0105a9e7ddf5abb3a8f8ef3bb2b48ab128..32072922d6b8e3cee8705d0169a1d083c8e08ad6 100644
--- a/src/liblzma/check/crc32_arm64.h
+++ b/src/liblzma/check/crc32_arm64.h
@@ -103,7 +103,7 @@ crc32_arch_optimized(const uint8_t *buf, size_t size, uint32_t crc)
 static inline bool
 is_arch_extension_supported(void)
 {
-#if defined(HAVE_GETAUXVAL)
+#if defined(__linux__) && defined(HAVE_GETAUXVAL)
 	return (getauxval(AT_HWCAP) & HWCAP_CRC32) != 0;
 
 #elif defined(HAVE_ELF_AUX_INFO)
diff --git a/src/liblzma/check/crc_common.h b/src/liblzma/check/crc_common.h
index 7ea1e60b043bf86dfe421e7594cb01812c51caa0..30a7b5c1a8f4185d76c926c3b41a5488b72ce6ed 100644
--- a/src/liblzma/check/crc_common.h
+++ b/src/liblzma/check/crc_common.h
@@ -89,7 +89,7 @@ extern const uint64_t lzma_crc64_table[4][256];
 // ARM64
 //
 // Keep this in sync with changes to crc32_arm64.h
-#if defined(_WIN32) || defined(HAVE_GETAUXVAL) \
+#if defined(_WIN32) || (defined(__linux__) && defined(HAVE_GETAUXVAL)) \
 		|| defined(HAVE_ELF_AUX_INFO) \
 		|| (defined(__APPLE__) && defined(HAVE_SYSCTLBYNAME))
 #	define CRC_ARM64_RUNTIME_DETECTION 1
